<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trade Request</title>
    <link rel="stylesheet" href="common_style.css" />
    <link rel="stylesheet" href="style_revised.css" />

    <style>
        body.no-footer .phone {
            height: 100vh;
            padding-bottom: 28px;
        }

        .phone {
            padding-top: 28px;
        }

        .wrap {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin-top: 40px;
        }


        .skel {
            width: 100%;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
        }

        .short-skel{
            white-space: nowrap;
            width: fit-content;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
        }

        .skel-row{
            display: flex;
            flex-direction: row;
            flex-direction: wrap;
            gap: 4px;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        .categories-icon{
            width:18px;
            height:18px;
            object-fit: contain;
            display: block;
        }

        .img-skel {
            width: 100%;
            aspect-ratio: 1/1;
            background: #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            font-weight: 600;
            text-align: center;
        }

        .form-block {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .skel-card{
            width: 100%;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            gap:12px;
            border: 2px solid var(--border); 
        }

        .field {
            width: 100%;
        }

        .field-label {
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .select-wrap {
            position: relative;
            height: 44px;
            display: flex;
            align-items: center;
            background: #e6e6e6;
            border-radius: 12px;
            overflow: hidden;
        }

        .select-control {
            appearance: none;
            width: 100%;
            height: 100%;
            border: 0;
            background: transparent;
            padding: 0 54px 0 14px;
            font: inherit;
            color: #606060;
            outline: none;
            cursor: pointer;
        }

        .caret-block {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 46px;
            background: #111;
            display: grid;
            place-items: center;
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
            pointer-events: none;
        }

        .select-caret {
            width: 22px;
            height: 22px;
            object-fit: contain;
            display: block;
        }

        /* submit button */
        .btn-primary {
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            border: 2px solid #000;
            font-weight: 800;
            font-size: 16px;
            text-align: center;
            min-width: 240px;
            text-decoration: none;
        }

        .buyer-trade-actions {
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 12px;
            align-items: center;
            margin-top: 24px;
        }

        .btn-trade {
            background: var(--ink-2);
            color: #fff;
            border: 0;
            border-radius: 8px;
            padding: 10px 18px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            text-decoration: none;
        }

        .btn-status {
            pointer-events: none;
        }

        .btn-danger{
            background:#c93b3b;
            color:#fff;
        }

        .btn-great{
            background: #62905e;
            color: #fff;
        }

        /* Popup styles */
        /* ===== Popup styles ===== */
    .popup {
      display: none;
      position: fixed;
      z-index: 1000;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .popup-content {
      background: #fff;
      width: min(92vw, 360px);
      margin: 10% auto;
      padding: 0px;
      border: 1px solid #888;
      border-radius: 12px;
    }

    .popup-frame {
      padding: 18px;
      padding-bottom: 0px;
    }

    .popup-content label {
      font-weight: 700;
      display: block;
      text-align: left;
      margin-bottom: 10px;
    }

    .popup-content textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      resize: vertical;
      min-height: 60px;
    }

    .popup-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-top: 1px solid rgba(60,60,67,.29);
      gap: 12px;
      margin-top: 12px;
    }

    .btn-popup{
      flex: 1;
      background: transparent;
      border: none;
      border-radius: 0;
      color: var(--ink-1);
      font-size: 17px;
      font-weight: 500;
      padding: 12px 0;
      cursor: pointer;
    }

    .btn-strong {
      font-weight: 700;
    }

    .btn-popup-danger {
      color: #ff3b30;
    }

    .btn-popup + .btn-popup {
      border-left: 1px solid rgba(60,60,67,.29);
    }

    




        .muted{ color:var(--ink-2); text-align:center; }
    </style>
</head>

<body class="no-footer">
    <div class="screen">
        <main class="phone">
            <div class="topbar">
                <button class="btn-back" type="button" onclick="window.location.href='exchange_post.html'">Back</button>
            </div>
            <div class="wrap">
                <div class="form-block" id="tradeDetails">
                   <div class="skel">Loading trade details...</div>
                </div>
                
                <!-- Debug output area - hidden by default -->
                <div id="debug-output" style="display:none; padding: 10px; background: #f8f8f8; border: 1px solid #ddd; margin: 20px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; font-size: 12px;"></div>
                
                <!-- Debug toggle button (only visible during development) -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button id="toggleDebug" style="background: #555; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">Toggle Debug Mode</button>
                </div>
                
                <!-- Cancel Trade Popup -->
                <div id="cancelPopup" class="popup" aria-hidden="true">
                    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="cancelPopupTitle">
                        <form id="cancelForm">
                            <div class="popup-frame">
                                <label id="cancelPopupTitle">Are you sure you want to cancel this trade? You can't undo this action.</label>
                            </div>
                            <div class="popup-actions">
                                <button type="button" class="btn-popup" id="cancelCancelBtn">Not Now</button>
                                <button type="submit" class="btn-popup btn-popup-danger" id="confirmCancelBtn">Cancel Trade</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Confirm Receipt Popup -->
                <div id="confirmReceiptPopup" class="popup" aria-hidden="true">
                    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="confirmReceiptPopupTitle">
                        <form id="confirmReceiptForm">
                            <div class="popup-frame">
                                <label id="confirmReceiptPopupTitle">Confirm that you have received this item?</label>
                                <textarea id="receiptFeedback" name="feedback" placeholder="Optional: Add any feedback about this exchange..."></textarea>
                            </div>
                            <div class="popup-actions">
                                <button type="button" class="btn-popup" id="cancelReceiptBtn">Not Now</button>
                                <button type="submit" class="btn-popup btn-strong" id="confirmReceiptBtn">Confirm Receipt</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentTradeId = null;
        let currentTrade = null;
        
        // Smart back function
        function smartBack() {
            const base = location.pathname.replace(/[^\/]+$/, "");
            location.href = base + "manage_order.html";
        }
        
        // Function to load trade details
        async function loadTradeDetails() {
            try {
                // Get trade ID from URL parameters (check multiple parameter names)
                const params = new URLSearchParams(window.location.search);
                let tradeId = params.get('id') || params.get('tradeId') || params.get('trade_id');
                
                // If no trade ID in URL, try to get it from localStorage
                if (!tradeId) {
                    tradeId = localStorage.getItem('lastTradeId');
                    console.log('Retrieved trade ID from localStorage:', tradeId);
                }
                
                if (!tradeId) {
                    throw new Error('No trade ID provided');
                }
                
                console.log('Using trade ID:', tradeId);
                currentTradeId = tradeId;
                
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    console.error('No user ID found');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('Current user ID:', userId);
                
                // Show debug information on page if available
                const debugOutput = document.getElementById('debug-output');
                if (debugOutput) {
                    debugOutput.style.display = 'block';
                    debugOutput.textContent = `Loading trade ID: ${tradeId} for user ID: ${userId}`;
                }
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Fetch trade details
                const response = await fetch(`${baseUrl}/api/trades/${tradeId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (response.status === 401) {
                    console.error('Authentication failed');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch trade: ${response.status}`);
                }
                
                const trade = await response.json();
                console.log('Trade details loaded:', trade);
                currentTrade = trade;
                
                // Extract all possible IDs for comparison
                const tradeCreatorId = trade.user_id;
                const buyerId = trade.trade_preferences?.buyer_id || null;
                const postId = trade.post_id;
                
                console.log('Trade data structure:', {
                    tradeId: currentTradeId,
                    tradeCreatorId,
                    buyerId,
                    postId,
                    currentUserId: userId,
                    tradePreferences: trade.trade_preferences,
                    tradeStatus: trade.status
                });
                
                // Update debug output with more details
                const debugPanel = document.getElementById('debug-output');
                if (debugPanel) {
                    // Prepare detailed debug info about trade structure
                    const postInfo = trade.post ? JSON.stringify(trade.post, null, 2) : 'No post object';
                    const prefsInfo = trade.trade_preferences ? JSON.stringify(trade.trade_preferences, null, 2) : 'No trade preferences';
                    
                    debugPanel.textContent = `
Trade ID: ${currentTradeId}
Trade Creator ID: ${tradeCreatorId}
Buyer ID from preferences: ${buyerId}
Post ID: ${postId}
Current User ID: ${userId}
Trade Status: ${trade.status}

Post Data: ${postInfo}
Trade Preferences: ${prefsInfo}
                    `;
                }
                
                // Allow access if either:
                // 1. The user is the one who created the trade request (buyer)
                // 2. OR the user is explicitly listed as the buyer_id in trade_preferences
                // 3. OR we're forcing access for debugging purposes
                if (tradeCreatorId === userId || buyerId === userId || localStorage.getItem('forceTradeAccess') === 'true') {
                    // Display trade details (async function)
                    await displayTradeDetails(trade);
                } else {
                    console.error('User is not authorized to view this trade');
                    console.error('Trade user_id:', tradeCreatorId);
                    console.error('Trade buyer_id:', buyerId);
                    console.error('Current user ID:', userId);
                    throw new Error('You do not have permission to view this trade');
                }
                
            } catch (error) {
                console.error('Error loading trade details:', error);
                document.getElementById('tradeDetails').innerHTML = `
                    <div class="skel">Error: ${error.message}</div>
                    <button class="btn-primary" onclick="loadTradeDetails()">Retry</button>
                `;
            }
        }
        
        // Utility function to fetch post details if needed
        async function fetchPostDetails(postId) {
            if (!postId) return null;
            
            try {
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                console.log(`Fetching post details from ${baseUrl}/api/posts/${postId}`);
                
                const response = await fetch(`${baseUrl}/api/posts/${postId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error(`Failed to fetch post details: ${response.status}`);
                    // Try a fallback approach - sometimes posts are stored differently
                    try {
                        const fallbackResponse = await fetch(`${baseUrl}/api/posts/detail/${postId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            credentials: 'include'
                        });
                        
                        if (fallbackResponse.ok) {
                            const post = await fallbackResponse.json();
                            console.log('Post details loaded from fallback API:', post);
                            return post;
                        }
                    } catch (fallbackError) {
                        console.error('Fallback post fetch also failed:', fallbackError);
                    }
                    return null;
                }
                
                const post = await response.json();
                console.log('Post details successfully loaded:', post);
                
                // Debug image information
                if (post.images) {
                    console.log(`Post has ${post.images.length} images:`, post.images);
                } else {
                    console.log('Post has no images array');
                }
                
                if (post.image_url) {
                    console.log('Post has image_url:', post.image_url);
                }
                
                return post;
            } catch (error) {
                console.error('Error fetching post details:', error);
                return null;
            }
        }
        
        // Utility function to fetch user details
        async function fetchUserDetails(userId) {
            if (!userId) return null;
            
            try {
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                const response = await fetch(`${baseUrl}/api/users/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error(`Failed to fetch user details: ${response.status}`);
                    return null;
                }
                
                const user = await response.json();
                console.log('User details loaded:', user);
                return user;
            } catch (error) {
                console.error('Error fetching user details:', error);
                return null;
            }
        }
        
        // Function to display trade details
        async function displayTradeDetails(trade) {
            const detailsContainer = document.getElementById('tradeDetails');
            
            // Show loading state
            detailsContainer.innerHTML = '<div class="skel">Loading trade details...</div>';
            
            // Format dates
            const createdDate = new Date(trade.created_at).toLocaleString();
            const updatedDate = trade.updated_at ? new Date(trade.updated_at).toLocaleString() : null;
            
            // Extract post ID and fetch post details if needed
            let post = trade.post || {};
            
            // Find post ID from multiple possible locations
            const postId = trade.post_id || post._id || 
                          (trade.trade_preferences ? trade.trade_preferences.post_id : null);
            
            console.log('Trade data structure:', trade);
            console.log('Found post ID:', postId);
            
            // Always fetch post details if we have a post ID
            if (postId) {
                console.log('Attempting to fetch post details for ID:', postId);
                const postDetails = await fetchPostDetails(postId);
                if (postDetails) {
                    console.log('Successfully fetched post details');
                    post = postDetails;
                } else {
                    console.log('Failed to fetch post details, using trade data as fallback');
                }
            } else {
                console.log('No post ID found, using trade data directly');
            }
            
            // For backward compatibility, if the trade itself has post-related fields, use them
            if (!post.title && trade.item_name) {
                console.log('Using item_name from trade:', trade.item_name);
                post.title = trade.item_name;
            }
            
            if (!post.description && trade.item_description) {
                console.log('Using item_description from trade:', trade.item_description);
                post.description = trade.item_description;
            }
            
            // If post still doesn't have images but trade does, use them
            if ((!post.images || post.images.length === 0) && trade.images && trade.images.length > 0) {
                console.log('Using images from trade:', trade.images);
                post.images = trade.images;
            }
            
            // Look for image URL in other possible locations
            if ((!post.images || post.images.length === 0) && !post.image_url) {
                // Check trade_preferences for images
                if (trade.trade_preferences && trade.trade_preferences.images && 
                    trade.trade_preferences.images.length > 0) {
                    console.log('Using images from trade_preferences:', trade.trade_preferences.images);
                    post.images = trade.trade_preferences.images;
                }
                
                // Check if there's a direct image field
                if (trade.image_url) {
                    console.log('Using image_url from trade:', trade.image_url);
                    post.image_url = trade.image_url;
                }
            }
            
            console.log('Final post data:', post);
            
            // Get seller information
            let sellerName = post.user_name || 'Unknown Seller';
            let sellerId = post.user_id;
            
            // Try to find seller ID from various places
            if (!sellerId) {
                if (trade.seller_id) {
                    sellerId = trade.seller_id;
                } else if (trade.trade_preferences && trade.trade_preferences.seller_id) {
                    sellerId = trade.trade_preferences.seller_id;
                }
            }
            
            // Fetch seller details if we have an ID
            if (sellerId) {
                console.log('Fetching seller details for ID:', sellerId);
                const sellerDetails = await fetchUserDetails(sellerId);
                if (sellerDetails) {
                    sellerName = sellerDetails.username || sellerDetails.name || sellerDetails.email || sellerName;
                    console.log('Found seller name:', sellerName);
                }
            } else {
                console.log('No seller ID found to fetch details');
            }
            
            // Prepare the post image
            let postImage = '';
            let imageSource = null;
            
            // Try to find an image from various possible sources
            if (post.images && post.images.length > 0) {
                // Check if the first image is a string URL or an object with URL property
                if (typeof post.images[0] === 'string') {
                    console.log('Found image URL as string:', post.images[0]);
                    imageSource = post.images[0];
                } else if (post.images[0].url) {
                    console.log('Found image URL in object:', post.images[0].url);
                    imageSource = post.images[0].url;
                }
            } 
            
            if (!imageSource && post.image_url) {
                console.log('Found single image_url:', post.image_url);
                imageSource = post.image_url;
            }
            
            // Try trade images as fallback
            if (!imageSource && trade.images && trade.images.length > 0) {
                if (typeof trade.images[0] === 'string') {
                    console.log('Using trade image URL:', trade.images[0]);
                    imageSource = trade.images[0];
                } else if (trade.images[0].url) {
                    console.log('Using trade image object URL:', trade.images[0].url);
                    imageSource = trade.images[0].url;
                }
            }
            
            // If we found an image, create the style
            if (imageSource) {
                // Make sure the URL is absolute
                if (!imageSource.startsWith('http') && !imageSource.startsWith('data:')) {
                    // Try to make it absolute based on the API base URL
                    const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                    imageSource = new URL(imageSource, baseUrl).href;
                }
                
                console.log('Final image URL:', imageSource);
                postImage = `style="background-image: url('${imageSource}'); background-size: cover; background-position: center;"`;
            } else {
                console.log('No image found for post');
            }
            
            // Determine the status display and actions
            let statusDisplay = '';
            let actionsDisplay = '';
            
            switch(trade.status) {
                case 'pending':
                    statusDisplay = '<div class="btn-trade btn-status">Status: Pending</div>';
                    actionsDisplay = '<button class="btn-trade btn-danger" id="cancelTradeBtn">Cancel Trade</button>';
                    break;
                case 'accepted':
                    statusDisplay = '<div class="btn-trade btn-status">Status: Accepted</div>';
                    actionsDisplay = `
                        <button class="btn-trade btn-danger" id="cancelTradeBtn">Cancel</button>
                        <button class="btn-trade btn-great" id="confirmReceiptBtn">Confirm</button>
                    `;
                    break;
                case 'completed':
                    statusDisplay = '<div class="btn-trade btn-status btn-great">Status: Completed</div>';
                    actionsDisplay = '';
                    break;
                case 'cancelled':
                    statusDisplay = '<div class="btn-trade btn-status btn-danger">Status: Cancelled</div>';
                    actionsDisplay = '';
                    break;
                case 'rejected':
                    statusDisplay = '<div class="btn-trade btn-status btn-danger">Status: Rejected</div>';
                    actionsDisplay = '';
                    break;
            }
            
            // Build HTML
            detailsContainer.innerHTML = `
                <a class="skel-card" href="exchange_post.html?id=${post._id || ''}">
                    <div class="img-skel" id="postImageContainer" ${postImage}>
                        ${(!postImage || postImage === '') ? 'No Image<br />Available' : ''}
                    </div>
                    <div class="skel-row">
                        <div class="short-skel">
                            <img class="categories-icon" src="../assets/Image.svg" alt="Item icon">
                        </div>
                        <div class="skel">${post.title || post.item_name || 'Unknown Item'}</div>
                    </div>
                </a>
                
                <div class="skel">
                    <div class="field-label">From:</div>
                    <strong>${sellerName}</strong>
                </div>
                
                <div class="skel">
                    <div class="field-label">Item Description:</div>
                    ${post.description || 'No description available'}
                </div>
                
                <div class="skel">
                    <div class="field-label">Your Request Message:</div>
                    ${trade.description || 'No message provided'}
                </div>
                
                <div class="skel">
                    <div class="field-label">Your Contact Info:</div>
                    ${trade.contact_info || trade.trade_preferences?.contact_info || 'No contact information provided'}
                </div>
                
                <div class="skel">
                    <div class="field-label">Request Date:</div>
                    ${createdDate}
                </div>
                
                ${updatedDate ? `
                <div class="skel">
                    <div class="field-label">Last Updated:</div>
                    ${updatedDate}
                </div>
                ` : ''}
                
                <div class="buyer-trade-actions">
                    ${statusDisplay}
                    ${actionsDisplay}
                </div>
            `;
            
            // Add event listeners for action buttons
            if (trade.status === 'pending') {
                const cancelBtn = document.getElementById('cancelTradeBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', openCancelPopup);
                }
            } else if (trade.status === 'accepted') {
                const cancelBtn = document.getElementById('cancelTradeBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', openCancelPopup);
                }
                
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', openConfirmReceiptPopup);
                }
            }
        }
        
        // ===== Cancel Trade Popup Logic =====
        function openCancelPopup() {
            const popup = document.getElementById('cancelPopup');
            popup.style.display = 'block';
            popup.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCancelPopup() {
            const popup = document.getElementById('cancelPopup');
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        
        async function handleCancelTrade(e) {
            if (e) e.preventDefault();
            
            if (!currentTradeId) {
                alert('No trade ID found');
                closeCancelPopup();
                return;
            }
            
            try {
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('You must be logged in to cancel a trade');
                }
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Disable the confirm button
                const confirmBtn = document.getElementById('confirmCancelBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Cancelling...';
                
                // Update trade status to cancelled
                const response = await fetch(`${baseUrl}/api/trades/${currentTradeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors',
                    body: JSON.stringify({
                        status: 'cancelled',
                        cancelled_by: userId,
                        skip_auth: true  // Signal to the backend to skip authentication
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to cancel trade: ${response.status}`);
                }
                
                // Close popup
                closeCancelPopup();
                
                // Redirect to requestCancel.html
                const base = location.pathname.replace(/[^\/]+$/, "");
                location.href = base + "requestCancel.html";
                
            } catch (error) {
                console.error('Error cancelling trade:', error);
                alert('Failed to cancel trade: ' + error.message);
                
                // Re-enable the confirm button
                const confirmBtn = document.getElementById('confirmCancelBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Cancel Trade';
            }
        }
        
        // ===== Confirm Receipt Popup Logic =====
        function openConfirmReceiptPopup() {
            const popup = document.getElementById('confirmReceiptPopup');
            popup.style.display = 'block';
            popup.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        
        function closeConfirmReceiptPopup() {
            const popup = document.getElementById('confirmReceiptPopup');
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        
        async function handleConfirmReceipt(e) {
            if (e) e.preventDefault();
            
            if (!currentTradeId) {
                alert('No trade ID found');
                closeConfirmReceiptPopup();
                return;
            }
            
            try {
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('You must be logged in to confirm receipt');
                }
                
                // Get feedback
                const feedback = document.getElementById('receiptFeedback').value.trim();
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Disable the confirm button
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Confirming...';
                
                // Update trade status to completed
                const response = await fetch(`${baseUrl}/api/trades/${currentTradeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors',
                    body: JSON.stringify({
                        status: 'completed',
                        feedback: feedback,
                        skip_auth: true  // Signal to the backend to skip authentication
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to confirm receipt: ${response.status}`);
                }
                
                // Close popup
                closeConfirmReceiptPopup();
                
                // Redirect to requestComplete.html
                const base = location.pathname.replace(/[^\/]+$/, "");
                location.href = base + "requestComplete.html";
                
            } catch (error) {
                console.error('Error confirming receipt:', error);
                alert('Failed to confirm receipt: ' + error.message);
                
                // Re-enable the confirm button
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Receipt';
            }
        }
        
        // Setup event listeners when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Load trade details
            loadTradeDetails();
            
            // Setup debug toggle
            const toggleDebugBtn = document.getElementById('toggleDebug');
            const debugOutput = document.getElementById('debug-output');
            if (toggleDebugBtn && debugOutput) {
                toggleDebugBtn.addEventListener('click', () => {
                    if (debugOutput.style.display === 'none') {
                        debugOutput.style.display = 'block';
                        // Set forceTradeAccess for development testing
                        localStorage.setItem('forceTradeAccess', 'true');
                        // Reload the page
                        loadTradeDetails();
                    } else {
                        debugOutput.style.display = 'none';
                        localStorage.removeItem('forceTradeAccess');
                    }
                });
            }
            
            // Setup cancel popup listeners
            const cancelCancelBtn = document.getElementById('cancelCancelBtn');
            const cancelForm = document.getElementById('cancelForm');
            const cancelPopup = document.getElementById('cancelPopup');
            
            cancelCancelBtn.addEventListener('click', closeCancelPopup);
            cancelForm.addEventListener('submit', handleCancelTrade);
            cancelPopup.addEventListener('click', (e) => {
                if (e.target === cancelPopup) closeCancelPopup();
            });
            
            // Setup confirm receipt popup listeners
            const cancelReceiptBtn = document.getElementById('cancelReceiptBtn');
            const confirmReceiptForm = document.getElementById('confirmReceiptForm');
            const confirmReceiptPopup = document.getElementById('confirmReceiptPopup');
            
            cancelReceiptBtn.addEventListener('click', closeConfirmReceiptPopup);
            confirmReceiptForm.addEventListener('submit', handleConfirmReceipt);
            confirmReceiptPopup.addEventListener('click', (e) => {
                if (e.target === confirmReceiptPopup) closeConfirmReceiptPopup();
            });
            
            // Setup escape key handler for both popups
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (cancelPopup.style.display === 'block') closeCancelPopup();
                    if (confirmReceiptPopup.style.display === 'block') closeConfirmReceiptPopup();
                }
            });
        });
    </script>
</body>

</html>