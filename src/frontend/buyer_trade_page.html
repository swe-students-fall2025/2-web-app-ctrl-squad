<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trade Request</title>
    <link rel="stylesheet" href="common_style.css" />
    <link rel="stylesheet" href="style_revised.css" />

    <style>
        body.no-footer .phone {
            height: 100vh;
            padding-bottom: 28px;
        }

        .phone {
            padding-top: 28px;
        }

        .wrap {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin-top: 40px;
        }


        .skel {
            width: 100%;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
        }

        .short-skel{
            white-space: nowrap;
            width: fit-content;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
        }

        .skel-row{
            display: flex;
            flex-direction: row;
            flex-direction: wrap;
            gap: 4px;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        .categories-icon{
            width:18px;
            height:18px;
            object-fit: contain;
            display: block;
        }

        .img-skel {
            width: 100%;
            aspect-ratio: 1/1;
            background: #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            font-weight: 600;
            text-align: center;
        }

        .form-block {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .skel-card{
            width: 100%;
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px;
            color: #606060;
            text-align: center;
            font-size: 14px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            gap:12px;
            border: 2px solid var(--border); 
        }

        .field {
            width: 100%;
        }

        .field-label {
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .select-wrap {
            position: relative;
            height: 44px;
            display: flex;
            align-items: center;
            background: #e6e6e6;
            border-radius: 12px;
            overflow: hidden;
        }

        .select-control {
            appearance: none;
            width: 100%;
            height: 100%;
            border: 0;
            background: transparent;
            padding: 0 54px 0 14px;
            font: inherit;
            color: #606060;
            outline: none;
            cursor: pointer;
        }

        .caret-block {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 46px;
            background: #111;
            display: grid;
            place-items: center;
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
            pointer-events: none;
        }

        .select-caret {
            width: 22px;
            height: 22px;
            object-fit: contain;
            display: block;
        }

        /* submit button */
        .btn-primary {
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            border: 2px solid #000;
            font-weight: 800;
            font-size: 16px;
            text-align: center;
            min-width: 240px;
            text-decoration: none;
        }

        .buyer-trade-actions {
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 12px;
            align-items: center;
            margin-top: 24px;
        }

        .btn-trade {
            background: var(--ink-2);
            color: #fff;
            border: 0;
            border-radius: 8px;
            padding: 10px 18px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            text-decoration: none;
        }

        .btn-status {
            pointer-events: none;
        }

        .btn-danger{
            background:#c93b3b;
            color:#fff;
        }

        .btn-great{
            background: #62905e;
            color: #fff;
        }

        /* Popup styles */
        /* ===== Popup styles ===== */
    .popup {
      display: none;
      position: fixed;
      z-index: 1000;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .popup-content {
      background: #fff;
      width: min(92vw, 360px);
      margin: 10% auto;
      padding: 0px;
      border: 1px solid #888;
      border-radius: 12px;
    }

    .popup-frame {
      padding: 18px;
      padding-bottom: 0px;
    }

    .popup-content label {
      font-weight: 700;
      display: block;
      text-align: left;
      margin-bottom: 10px;
    }

    .popup-content textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      resize: vertical;
      min-height: 60px;
    }

    .popup-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-top: 1px solid rgba(60,60,67,.29);
      gap: 12px;
      margin-top: 12px;
    }

    .btn-popup{
      flex: 1;
      background: transparent;
      border: none;
      border-radius: 0;
      color: var(--ink-1);
      font-size: 17px;
      font-weight: 500;
      padding: 12px 0;
      cursor: pointer;
    }

    .btn-strong {
      font-weight: 700;
    }

    .btn-popup-danger {
      color: #ff3b30;
    }

    .btn-popup + .btn-popup {
      border-left: 1px solid rgba(60,60,67,.29);
    }

    




        .muted{ color:var(--ink-2); text-align:center; }
    </style>
</head>

<body class="no-footer">
    <div class="screen">
        <main class="phone">
            <div class="topbar">
                <button class="btn-back" type="button" onclick="window.location.href='exchange_post.html'">Back</button>
            </div>
            <div class="wrap">
                <div class="form-block" id="tradeDetails">
                   <div class="skel">Loading trade details...</div>
                </div>
                
                <!-- Cancel Trade Popup -->
                <div id="cancelPopup" class="popup" aria-hidden="true">
                    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="cancelPopupTitle">
                        <form id="cancelForm">
                            <div class="popup-frame">
                                <label id="cancelPopupTitle">Are you sure you want to cancel this trade? You can't undo this action.</label>
                            </div>
                            <div class="popup-actions">
                                <button type="button" class="btn-popup" id="cancelCancelBtn">Not Now</button>
                                <button type="submit" class="btn-popup btn-popup-danger" id="confirmCancelBtn">Cancel Trade</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Confirm Receipt Popup -->
                <div id="confirmReceiptPopup" class="popup" aria-hidden="true">
                    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="confirmReceiptPopupTitle">
                        <form id="confirmReceiptForm">
                            <div class="popup-frame">
                                <label id="confirmReceiptPopupTitle">Confirm that you have received this item?</label>
                                <textarea id="receiptFeedback" name="feedback" placeholder="Optional: Add any feedback about this exchange..."></textarea>
                            </div>
                            <div class="popup-actions">
                                <button type="button" class="btn-popup" id="cancelReceiptBtn">Not Now</button>
                                <button type="submit" class="btn-popup btn-strong" id="confirmReceiptBtn">Confirm Receipt</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentTradeId = null;
        let currentTrade = null;
        
        // Smart back function
        function smartBack() {
            const base = location.pathname.replace(/[^\/]+$/, "");
            location.href = base + "manage_order.html";
        }
        
        // Function to load trade details
        async function loadTradeDetails() {
            try {
                // Get trade ID from URL parameters (check multiple parameter names)
                const params = new URLSearchParams(window.location.search);
                let tradeId = params.get('id') || params.get('tradeId') || params.get('trade_id');
                
                // If no trade ID in URL, try to get it from localStorage
                if (!tradeId) {
                    tradeId = localStorage.getItem('lastTradeId');
                    console.log('Retrieved trade ID from localStorage:', tradeId);
                }
                
                if (!tradeId) {
                    throw new Error('No trade ID provided');
                }
                
                console.log('Using trade ID:', tradeId);
                currentTradeId = tradeId;
                
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    console.error('No user ID found');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Fetch trade details
                const response = await fetch(`${baseUrl}/api/trades/${tradeId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (response.status === 401) {
                    console.error('Authentication failed');
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch trade: ${response.status}`);
                }
                
                const trade = await response.json();
                console.log('Trade details loaded:', trade);
                currentTrade = trade;
                
                // Verify this user is the buyer
                if (trade.buyer_id !== userId) {
                    throw new Error('You do not have permission to view this trade');
                }
                
                // Display trade details
                displayTradeDetails(trade);
                
            } catch (error) {
                console.error('Error loading trade details:', error);
                document.getElementById('tradeDetails').innerHTML = `
                    <div class="skel">Error: ${error.message}</div>
                    <button class="btn-primary" onclick="loadTradeDetails()">Retry</button>
                `;
            }
        }
        
        // Function to display trade details
        function displayTradeDetails(trade) {
            const post = trade.post || {};
            const detailsContainer = document.getElementById('tradeDetails');
            
            // Format dates
            const createdDate = new Date(trade.created_at).toLocaleString();
            const updatedDate = trade.updated_at ? new Date(trade.updated_at).toLocaleString() : null;
            
            // Prepare the post image
            const postImage = post.images && post.images.length > 0 
                ? `style="background-image: url('${post.images[0]}'); background-size: cover; background-position: center;"`
                : '';
            
            // Determine the status display and actions
            let statusDisplay = '';
            let actionsDisplay = '';
            
            switch(trade.status) {
                case 'pending':
                    statusDisplay = '<div class="btn-trade btn-status">Status: Pending</div>';
                    actionsDisplay = '<button class="btn-trade btn-danger" id="cancelTradeBtn">Cancel Trade</button>';
                    break;
                case 'accepted':
                    statusDisplay = '<div class="btn-trade btn-status">Status: Accepted</div>';
                    actionsDisplay = '<button class="btn-trade btn-great" id="confirmReceiptBtn">Confirm Receipt</button>';
                    break;
                case 'completed':
                    statusDisplay = '<div class="btn-trade btn-status btn-great">Status: Completed</div>';
                    actionsDisplay = '';
                    break;
                case 'cancelled':
                    statusDisplay = '<div class="btn-trade btn-status btn-danger">Status: Cancelled</div>';
                    actionsDisplay = '';
                    break;
                case 'rejected':
                    statusDisplay = '<div class="btn-trade btn-status btn-danger">Status: Rejected</div>';
                    actionsDisplay = '';
                    break;
            }
            
            // Build HTML
            detailsContainer.innerHTML = `
                <a class="skel-card" href="exchange_post.html?id=${post._id || ''}">
                    <div class="img-skel" ${postImage}>
                        ${!post.images || post.images.length === 0 ? 'No Image<br />Available' : ''}
                    </div>
                    <div class="skel-row">
                        <div class="short-skel">
                            <img class="categories-icon" src="../assets/Image.svg" alt="Item icon">
                        </div>
                        <div class="skel">${post.title || 'Unknown Item'}</div>
                    </div>
                </a>
                
                <a class="skel" href="#">From: ${post.user_name || 'Unknown Seller'}</a>
                
                <div class="skel">
                    <div class="field-label">Description:</div>
                    ${post.description || 'No description available'}
                </div>
                
                <div class="skel">
                    <div class="field-label">Your Contact Info:</div>
                    ${trade.contact_info || 'No contact information provided'}
                </div>
                
                <div class="skel">
                    <div class="field-label">Request Date:</div>
                    ${createdDate}
                </div>
                
                ${updatedDate ? `
                <div class="skel">
                    <div class="field-label">Last Updated:</div>
                    ${updatedDate}
                </div>
                ` : ''}
                
                <div class="buyer-trade-actions">
                    ${statusDisplay}
                    ${actionsDisplay}
                </div>
            `;
            
            // Add event listeners for action buttons
            if (trade.status === 'pending') {
                const cancelBtn = document.getElementById('cancelTradeBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', openCancelPopup);
                }
            } else if (trade.status === 'accepted') {
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', openConfirmReceiptPopup);
                }
            }
        }
        
        // ===== Cancel Trade Popup Logic =====
        function openCancelPopup() {
            const popup = document.getElementById('cancelPopup');
            popup.style.display = 'block';
            popup.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCancelPopup() {
            const popup = document.getElementById('cancelPopup');
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        
        async function handleCancelTrade(e) {
            if (e) e.preventDefault();
            
            if (!currentTradeId) {
                alert('No trade ID found');
                closeCancelPopup();
                return;
            }
            
            try {
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('You must be logged in to cancel a trade');
                }
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Disable the confirm button
                const confirmBtn = document.getElementById('confirmCancelBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Cancelling...';
                
                // Update trade status to cancelled
                const response = await fetch(`${baseUrl}/api/trades/${currentTradeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors',
                    body: JSON.stringify({
                        status: 'cancelled',
                        cancelled_by: userId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to cancel trade: ${response.status}`);
                }
                
                // Close popup and reload trade details
                closeCancelPopup();
                
                // Refresh the page or redirect
                alert('Trade cancelled successfully');
                window.location.href = 'manage_order.html';
                
            } catch (error) {
                console.error('Error cancelling trade:', error);
                alert('Failed to cancel trade: ' + error.message);
                
                // Re-enable the confirm button
                const confirmBtn = document.getElementById('confirmCancelBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Cancel Trade';
            }
        }
        
        // ===== Confirm Receipt Popup Logic =====
        function openConfirmReceiptPopup() {
            const popup = document.getElementById('confirmReceiptPopup');
            popup.style.display = 'block';
            popup.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        
        function closeConfirmReceiptPopup() {
            const popup = document.getElementById('confirmReceiptPopup');
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        
        async function handleConfirmReceipt(e) {
            if (e) e.preventDefault();
            
            if (!currentTradeId) {
                alert('No trade ID found');
                closeConfirmReceiptPopup();
                return;
            }
            
            try {
                // Get current user ID
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('You must be logged in to confirm receipt');
                }
                
                // Get feedback
                const feedback = document.getElementById('receiptFeedback').value.trim();
                
                // Get API base URL
                const baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:5000';
                
                // Disable the confirm button
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Confirming...';
                
                // Update trade status to completed
                const response = await fetch(`${baseUrl}/api/trades/${currentTradeId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': userId
                    },
                    credentials: 'include',
                    mode: 'cors',
                    body: JSON.stringify({
                        status: 'completed',
                        feedback: feedback
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to confirm receipt: ${response.status}`);
                }
                
                // Close popup
                closeConfirmReceiptPopup();
                
                // Show success message and redirect
                alert('Receipt confirmed. Trade completed successfully!');
                window.location.href = 'manage_order.html';
                
            } catch (error) {
                console.error('Error confirming receipt:', error);
                alert('Failed to confirm receipt: ' + error.message);
                
                // Re-enable the confirm button
                const confirmBtn = document.getElementById('confirmReceiptBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Receipt';
            }
        }
        
        // Setup event listeners when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Load trade details
            loadTradeDetails();
            
            // Setup cancel popup listeners
            const cancelCancelBtn = document.getElementById('cancelCancelBtn');
            const cancelForm = document.getElementById('cancelForm');
            const cancelPopup = document.getElementById('cancelPopup');
            
            cancelCancelBtn.addEventListener('click', closeCancelPopup);
            cancelForm.addEventListener('submit', handleCancelTrade);
            cancelPopup.addEventListener('click', (e) => {
                if (e.target === cancelPopup) closeCancelPopup();
            });
            
            // Setup confirm receipt popup listeners
            const cancelReceiptBtn = document.getElementById('cancelReceiptBtn');
            const confirmReceiptForm = document.getElementById('confirmReceiptForm');
            const confirmReceiptPopup = document.getElementById('confirmReceiptPopup');
            
            cancelReceiptBtn.addEventListener('click', closeConfirmReceiptPopup);
            confirmReceiptForm.addEventListener('submit', handleConfirmReceipt);
            confirmReceiptPopup.addEventListener('click', (e) => {
                if (e.target === confirmReceiptPopup) closeConfirmReceiptPopup();
            });
            
            // Setup escape key handler for both popups
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (cancelPopup.style.display === 'block') closeCancelPopup();
                    if (confirmReceiptPopup.style.display === 'block') closeConfirmReceiptPopup();
                }
            });
        });
    </script>
</body>

</html>