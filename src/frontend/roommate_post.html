<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CasaConnect — Roommate Post Detail</title>
    <link rel="stylesheet" href="common_style.css" />

    <style>
        .phone {
            padding-top: 28px;
        }


        .after-topbar {
            margin-top: 0;
        }

        .wrap {

            display: flex;
            flex-direction: column;
            gap: 24px;
            
        }

        .card {
            background: var(--panel, #fff);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,.06);
            }
        
        .card-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #e9e9e9;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        margin-bottom: 12px;
        }

        .img-holder { 
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #ddd;
            margin-bottom: 12px 
        }

        .img-holder img { 
            width: 100%;
            aspect-ratio: 16 / 9;     
            object-fit: cover;
            display: block;
        }


        /* when there is no image */
        .card.no-image .img-holder { 
            background:#efefef; 
            height: 140px; 
        }

        .card.no-image .title { 
            margin-top: 4px; 
        }

        .skel-row {
            background: #e6e6e6;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            color: #111;
            font-weight: 700;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 8px;

        }


        .info-line, .title, .desc { margin-bottom: 10px; }

        .title { 
            font-size: 1.15rem; 
            font-weight: 800; 
        }

        .desc { 
            background: #eee; 
            border-radius: 14px; 
            padding: 14px; 
        }

        .info-line{
            background: #e6e6e6;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            color: #111;
            font-weight: 700;
        }


        .img-skel {
            width: 100%;
            height: 320px;
            background: #d9d9d9;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: #111;
            text-align: center;
        }

        .block {
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px 14px;
            color: #111;
        }

        .block.title {
            font-weight: 700;
        }


        .block.desc {
            min-height: 200px;
            line-height: 1.5;
            width: 100%;
        }

        .meta-small {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 6px;
        }

        .btn-action {
            text-decoration: none;
            color: #fff;
            background: #000;
            border: 2px solid #000;
            border-radius: 10px;
            padding: 12px 14px;
            font-weight: 800;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .like-badge {
            font-weight: 800;
        }



        @media (max-width: 360px) {
            .img-skel {
                height: 320px;
            }
        }
    </style>
</head>

<body class="no-footer">
    <div class="screen">
        <main class="phone">

            <div class="topbar">
                <button class="btn-back" type="button" onclick="smartBack()">Back</button>
            </div>

            <!-- main content -->
            <div class="after-topbar">
                <div class="wrap">

                    <div id="posts"></div>

                <template id="postTpl">
                <article class="card">
                    <div class="card-head">
                    <span class="u-name">username</span>
                    <span class="u-year">year</span>
                    </div>

                    <div class="img-holder">
                    <img class="u-img" alt="roommate image"/>
                    </div>

                    <div class="info-line t-loc">&lt;place to live&gt;</div>
                    <div class="block title t-title">Post title</div>
                    <div class="block desc t-desc">Description…</div>
                    <div class="meta-small t-meta">Last edited —</div>

                    <div class="actions">
                    <button class="btn-action favBtn" type="button">
                        <span>favorites</span>
                        <span class="like-badge likeCount">(0)</span>
                    </button>
                    <a class="btn-action matchBtn" href="match_confirm.html">match</a>
                    </div>
                    <!-- Owner actions container (edit and delete) will be shown if user is the owner -->
                    <div class="owner-actions" style="margin-top: 16px; display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <a class="btn-action" id="editPostBtn" style="background: #007bff;" href="">Edit Post</a>
                            <button class="btn-action" id="deletePostBtn" style="background: #c93b3b;">Delete Post</button>
                        </div>
                    </div>
                </article>
                </template>

                    
                </div>
            </div>
            
            <!-- Delete Confirmation Popup -->
            <div id="deletePopup" class="popup" aria-hidden="true" style="display: none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0, 0, 0, 0.4);">
                <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="deletePopupTitle" style="background: #fff; width: min(92vw, 360px); margin: 10% auto; padding: 0px; border: 1px solid #888; border-radius: 12px;">
                    <form id="deleteForm">
                        <div class="popup-frame" style="padding: 18px; padding-bottom: 0px;">
                            <label id="deletePopupTitle" style="font-weight: 700; display: block; text-align: left; margin-bottom: 10px;">Are you sure you want to delete this roommate post? This action cannot be undone.</label>
                        </div>
                        <div class="popup-actions" style="display: flex; margin-top: 16px;">
                            <button type="button" class="btn-popup" id="cancelDeleteBtn" style="flex: 1; padding: 16px; border: none; background: transparent; font-weight: 700; cursor: pointer; border-top: 1px solid #eee; color: #606060;">Cancel</button>
                            <button type="submit" class="btn-popup btn-popup-danger" id="confirmDeleteBtn" style="flex: 1; padding: 16px; border: none; background: transparent; font-weight: 700; cursor: pointer; border-top: 1px solid #eee; color: #c93b3b;">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        function smartBack() {
            // Always redirect to the profile page
            const profileUrl = location.pathname.replace(/[^\/]+$/, "") + "profile.html";
            
            try {
                // Create full URL by combining with current origin
                const fullUrl = new URL(profileUrl, window.location.origin);
                // Add refresh parameter to prevent caching issues
                fullUrl.searchParams.set('refresh', Date.now());
                location.href = fullUrl.toString();
            } catch (error) {
                console.error('Error creating URL:', error);
                // Fallback: just use the simple profile path
                location.href = profileUrl;
            }
        }

        function applyTopbarOffset() {
            const topbar = document.querySelector('.topbar');
            const after = document.querySelector('.after-topbar');
            if (!topbar || !after) return;
            const h = Math.ceil(topbar.getBoundingClientRect().height);
            const extra = 8; // extra breathing space
            after.style.marginTop = (h + extra) + 'px';
        }
        window.addEventListener('load', applyTopbarOffset);
        window.addEventListener('resize', applyTopbarOffset);
    </script>

    <!-- fetch roommate posts -->
    <script>
        const API_BASE = "http://127.0.0.1:5000"; // Flask server
        const API_LIST = `${API_BASE}/api/roommates`;

        const esc = s => String(s||"").replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
        );
        
        // Check user authentication status when page loads and store in global variable
        let currentUserId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in - try multiple storage methods
            let storedId = localStorage.getItem('currentUserId');
            let sessionId = sessionStorage.getItem('currentUserId');
            
            // Filter out "undefined" string values that might be stored
            if (storedId === "undefined" || storedId === "null") storedId = null;
            if (sessionId === "undefined" || sessionId === "null") sessionId = null;
            
            currentUserId = storedId || sessionId;
            
            const userToken = localStorage.getItem('token') || 
                             sessionStorage.getItem('token');
            
            console.log('User authentication status:', {
                currentUserId: currentUserId,
                hasToken: !!userToken,
                localStorage: storedId,
                sessionStorage: sessionId,
                cookies: document.cookie
            });
            
            // If user is not logged in but we're coming from profile page, something's wrong
            if (!currentUserId && !userToken && getUrlParam('owner') === 'true') {
                console.warn('User ID missing but coming from profile page. Trying to recover...');
                
                // Try to parse user ID from cookies as a fallback
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'userId' || name === 'currentUserId' || name === 'user_id') {
                        currentUserId = value;
                        console.log('Recovered user ID from cookie:', currentUserId);
                        // Save it to localStorage for future use
                        localStorage.setItem('currentUserId', currentUserId);
                        break;
                    }
                }
            }
            
            // Load posts after authentication check
            loadPosts();
        });

        // Function to get URL parameters
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        
        // Global variable to store current post ID
        let currentPostId = null;
        
        // Function to check if the current user is the owner of the post
        async function checkOwnership(postId, userIdToCheck) {
            try {
                const response = await fetch(`${API_BASE}/api/roommates/${postId}`);
                if (!response.ok) return false;
                
                const data = await response.json();
                if (!data.success || !data.post) return false;
                
                return data.post.user_id === userIdToCheck;
            } catch (error) {
                console.error('Error checking ownership:', error);
                return false;
            }
        }
        
        // Delete popup functions
        function openDeletePopup() {
            const popup = document.getElementById('deletePopup');
            popup.style.display = 'block';
            popup.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDeletePopup() {
            const popup = document.getElementById('deletePopup');
            popup.style.display = 'none';
            popup.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
        
        // Function to handle post deletion
        async function handleDeletePost(e) {
            if (e) e.preventDefault();
            
            if (!currentPostId) {
                alert('No post ID found');
                closeDeletePopup();
                return;
            }
            
            try {
                // Use the global currentUserId that was set earlier
                if (!currentUserId) {
                    throw new Error('You must be logged in to delete this post');
                }
                
                // Disable the delete button
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Deleting...';
                
                // Delete the post
                // Include both cookie-based authentication and X-User-ID header for compatibility
                const response = await fetch(`${API_BASE}/api/roommates/${currentPostId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin,
                        'X-User-ID': currentUserId // Add back the user ID header for API compatibility
                    },
                    credentials: 'include',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete post: ${response.status}`);
                }
                
                // Close popup
                closeDeletePopup();
                
                // Redirect to profile page
                alert('Roommate post deleted successfully');
                window.location.href = 'profile.html';
                
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Failed to delete post: ' + error.message);
                
                // Re-enable the delete button
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete';
            }
        }
        
        async function loadPosts() {
        try {
            // Get the post ID from URL if present (for individual post view)
            const postId = getUrlParam('id');
            currentPostId = postId; // Store for later use
            
            // We'll use the global currentUserId that was set in DOMContentLoaded
            // as a fallback, try to get it directly
            if (!currentUserId) {
                // Get stored IDs
                let storedId = localStorage.getItem('currentUserId');
                let sessionId = sessionStorage.getItem('currentUserId');
                
                // Filter out "undefined" string values that might be stored
                if (storedId === "undefined" || storedId === "null") storedId = null;
                if (sessionId === "undefined" || sessionId === "null") sessionId = null;
                
                currentUserId = storedId || sessionId;
            }
            
            // For owner=true coming from profile page, force ownership
            if (getUrlParam('owner') === 'true' && !currentUserId) {
                console.log('Coming from profile with owner=true but no userId. Setting temporary ID.');
                // Set a temporary ID just to show the edit buttons
                currentUserId = 'temp-id-from-profile';
            }
            
            console.log('Authentication data:', {
                'currentUserId': currentUserId,
                'localStorage userId': localStorage.getItem('currentUserId'),
                'sessionStorage userId': sessionStorage.getItem('currentUserId'),
                'document.cookie': document.cookie
            });
            
            let url = API_LIST;
            if (postId) {
                url = `${API_BASE}/api/roommates/${postId}`;
                console.log('Fetching roommate post with ID:', postId, 'URL:', url);
            }
            
            const r = await fetch(url);
            const data = await r.json();
            if (!data.success) throw new Error("API error");
            
            const root = document.getElementById("posts");   
            root.innerHTML = "";
            
            // For single post view
            if (postId) {
                if (!data.post) {
                    root.innerHTML = "<p>Roommate post not found.</p>";
                    return;
                }
                
                const posts = [data.post];
                renderPosts(posts, root);
                
                // Check if current user is the owner of this post - multiple methods
                // 1. Check if post has owner flag in data
                // 2. Check URL parameter (coming from profile page)
                // 3. Compare user IDs as strings
                
                const postOwnerId = data.post.user_id || data.post.userId || '';
                // Use the global currentUserId that was set earlier
                const comingFromProfile = getUrlParam('owner') === 'true';
                
                console.log('User data check:', {
                    'currentUserId': currentUserId,
                    'post owner id': postOwnerId,
                    'coming from profile': comingFromProfile,
                    'post data': data.post
                });
                
                // Multiple ownership checks (any can pass)
                let isOwner = 
                    data.post.is_owner === true || // API explicitly says user is owner
                    comingFromProfile ||           // Coming from profile page (user's own posts)
                    (postOwnerId && currentUserId && 
                     String(postOwnerId) === String(currentUserId)); // ID comparison
                
                // IMPORTANT: If we came from profile page, force ownership to true
                // This ensures buttons show up when coming from the user's own profile
                if (getUrlParam('owner') === 'true') {
                    console.log('Forcing ownership to true because coming from profile page');
                    isOwner = true;
                }
                    
                console.log('Ownership determination result:', isOwner);
                
                // For emergency debugging/testing only
                // const isOwner = true; // Uncomment to force ownership controls
                
                console.log('Checking post ownership:', {
                    currentUserId: currentUserId,
                    postOwnerId: postOwnerId,
                    isOwner: isOwner
                });
                
                // First, make sure the owner-actions container exists and is properly setup
                // Find or create the owner actions container
                let ownerActionsContainer = document.querySelector('.owner-actions');
                
                if (!ownerActionsContainer) {
                    console.log('Owner actions container not found, creating one');
                    // Create the container if it doesn't exist
                    ownerActionsContainer = document.createElement('div');
                    ownerActionsContainer.className = 'owner-actions';
                    ownerActionsContainer.style.marginTop = '16px';
                    
                    // Create the buttons container
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.style.display = 'grid';
                    buttonsContainer.style.gridTemplateColumns = '1fr 1fr';
                    buttonsContainer.style.gap = '10px';
                    
                    // Create edit button
                    const editBtn = document.createElement('a');
                    editBtn.className = 'btn-action';
                    editBtn.id = 'editPostBtn';
                    editBtn.style.background = '#007bff';
                    editBtn.href = `roomatePost_edit.html?id=${currentPostId}&owner=true`;
                    editBtn.textContent = 'Edit Post';
                    
                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-action';
                    deleteBtn.id = 'deletePostBtn';
                    deleteBtn.style.background = '#c93b3b';
                    deleteBtn.textContent = 'Delete Post';
                    
                    // Add buttons to container
                    buttonsContainer.appendChild(editBtn);
                    buttonsContainer.appendChild(deleteBtn);
                    ownerActionsContainer.appendChild(buttonsContainer);
                    
                    // Add container to the post (after the like button)
                    const likeBtn = document.querySelector('.like-btn');
                    if (likeBtn && likeBtn.parentElement) {
                        likeBtn.parentElement.after(ownerActionsContainer);
                    } else {
                        // If we can't find the like button, add it to the main content
                        const postMain = document.querySelector('.post-main');
                        if (postMain) {
                            postMain.appendChild(ownerActionsContainer);
                        }
                    }
                    
                    // Setup delete button listeners
                    deleteBtn.addEventListener('click', openDeletePopup);
                    
                    // Make sure the delete popup cancel button is setup
                    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                    if (cancelDeleteBtn) {
                        cancelDeleteBtn.addEventListener('click', closeDeletePopup);
                    }
                    
                    // Make sure the delete form is setup
                    const deleteForm = document.getElementById('deleteForm');
                    if (deleteForm) {
                        deleteForm.addEventListener('submit', handleDeletePost);
                    }
                }
                
                if (isOwner) {
                    // Show owner actions container
                    console.log('Showing owner actions - User IS the owner');
                    ownerActionsContainer.style.display = 'block !important';
                    ownerActionsContainer.setAttribute('style', 'margin-top: 16px; display: block !important');
                    
                    // Get the edit and delete buttons (they might be newly created)
                    const editButton = document.getElementById('editPostBtn');
                    if (editButton) {
                        editButton.href = `roomatePost_edit.html?id=${currentPostId}&owner=true`;
                        console.log('Edit button set to:', editButton.href);
                    }
                    
                    // Setup edit button with link to edit page
                    const editBtn = document.getElementById('editPostBtn');
                    if (editBtn) {
                        editBtn.href = `roomatePost_edit.html?id=${currentPostId}&owner=true`;
                        console.log('Edit button set to:', editBtn.href);
                    } else {
                        console.error('Edit button not found in the DOM');
                    }
                    
                    // Setup delete button and popup
                    const deleteBtn = document.getElementById('deletePostBtn');
                    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
                    const deleteForm = document.getElementById('deleteForm');
                    
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', openDeletePopup);
                    } else {
                        console.error('Delete button not found in the DOM');
                    }
                    
                    if (cancelDeleteBtn) {
                        cancelDeleteBtn.addEventListener('click', closeDeletePopup);
                    }
                    
                    if (deleteForm) {
                        deleteForm.addEventListener('submit', handleDeletePost);
                    }
                    
                    console.log('User is the owner of this post - showing edit and delete buttons');
                } else {
                    console.log('User is not the owner of this post - hiding owner actions');
                    // Make sure owner actions are hidden
                    if (ownerActionsContainer) {
                        ownerActionsContainer.style.display = 'none';
                    }
                }
                return;
            }
            
            // For list view
            if (!data.roommates || data.roommates.length === 0) {
                root.innerHTML = "<p>No roommate posts yet.</p>";
                return;
            }

            renderPosts(data.roommates, root);
        } catch (e) {
            console.error(e);
            alert("Failed to load posts. Check Flask/CORS.");
        }
        }
        
        // Function to render posts
        function renderPosts(posts, container) {
            try {
                const tpl = document.getElementById("postTpl");
                
                posts.forEach(p => {
                    const frag = tpl.content.cloneNode(true);
                    const card = frag.querySelector(".card");
                    
                    // Log post data to help debug
                    console.log('Rendering roommate post:', p);
                    
                    // username / year
                    frag.querySelector(".u-name").textContent = p.username || "username";
                    frag.querySelector(".u-year").textContent = p.year || "year";
                    
                    // image - handle different image field structures
                    const imgHolder = frag.querySelector(".img-holder");
                    const imgEl = frag.querySelector(".u-img");
                    let imageUrl = '';
                    
                    if (Array.isArray(p.images) && p.images[0]) {
                        imageUrl = String(p.images[0]).trim();
                    } else if (p.imageUrl) {
                        imageUrl = String(p.imageUrl).trim();
                    }
                    
                    if (imageUrl) {
                        imgEl.src = imageUrl;
                        imgEl.alt = p.title || "roommate image";
                        card.classList.add("has-image");
                    } else {
                        card.classList.add("no-image");
                    }
                    
                    // location / title / description
                    frag.querySelector(".t-loc").innerHTML = `&lt;${(p.location || "place to live")}&gt;`;
                    frag.querySelector(".t-title").textContent = p.title || "Post title";
                    frag.querySelector(".t-desc").textContent = p.description || "Description…";
                    
                    // meta - handle different date field names
                    const when = p.updated_at || p.updatedAt || p.created_at || p.createdAt;
                    frag.querySelector(".t-meta").textContent =
                        `Last edited ${when ? new Date(when).toLocaleString() : "—"}`;
                    
                    // favorites demo (client-side only)
                    const likeBadge = frag.querySelector(".likeCount");
                    let count = Number(p.favorites || 0);
                    likeBadge.textContent = `(${count})`;
                    frag.querySelector(".favBtn").addEventListener("click", () => {
                        count += 1;
                        likeBadge.textContent = `(${count})`;
                    });
                    
                    // match link carries the id - handle different id field names
                    const postId = p._id || p.id || '';
                    frag.querySelector(".matchBtn").href = `match_confirm.html?post=${encodeURIComponent(postId)}`;
                    
                    container.appendChild(frag);
                });
            } catch (e) {
                console.error(e);
                alert("Failed to load posts. Check Flask/CORS.");
            }
        }

        window.addEventListener("load", loadPosts);
        </script>

    </body>

</html>