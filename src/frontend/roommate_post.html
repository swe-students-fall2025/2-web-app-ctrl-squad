<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CasaConnect — Roommate Post Detail</title>
    <link rel="stylesheet" href="common_style.css" />

    <style>
        .phone {
            padding-top: 28px;
        }


        .after-topbar {
            margin-top: 0;
        }

        .wrap {

            display: flex;
            flex-direction: column;
            gap: 24px;
            
        }

        .card {
            background: var(--panel, #fff);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,.06);
            }
        
        .card-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #e9e9e9;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        margin-bottom: 12px;
        }

        .img-holder { 
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #ddd;
            margin-bottom: 12px 
        }

        .img-holder img { 
            width: 100%;
            aspect-ratio: 16 / 9;     
            object-fit: cover;
            display: block;
        }


        /* when there is no image */
        .card.no-image .img-holder { 
            background:#efefef; 
            height: 140px; 
        }

        .card.no-image .title { 
            margin-top: 4px; 
        }

        .skel-row {
            background: #e6e6e6;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            color: #111;
            font-weight: 700;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 8px;

        }


        .info-line, .title, .desc { margin-bottom: 10px; }

        .title { 
            font-size: 1.15rem; 
            font-weight: 800; 
        }

        .desc { 
            background: #eee; 
            border-radius: 14px; 
            padding: 14px; 
        }

        .info-line{
            background: #e6e6e6;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            color: #111;
            font-weight: 700;
        }


        .img-skel {
            width: 100%;
            height: 320px;
            background: #d9d9d9;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: #111;
            text-align: center;
        }

        .block {
            background: #e6e6e6;
            border-radius: 8px;
            padding: 12px 14px;
            color: #111;
        }

        .block.title {
            font-weight: 700;
        }


        .block.desc {
            min-height: 200px;
            line-height: 1.5;
            width: 100%;
        }

        .meta-small {
            font-size: 12px;
            color: #666;
            margin-top: px;
            margin-bottom: 12px;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 6px;
        }

        .btn-action {
            text-decoration: none;
            color: #fff;
            background: #000;
            border: 2px solid #000;
            border-radius: 10px;
            padding: 12px 14px;
            font-weight: 800;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .like-badge {
            font-weight: 800;
        }



        @media (max-width: 360px) {
            .img-skel {
                height: 320px;
            }
        }
    </style>
</head>

<body class="no-footer">
    <div class="screen">
        <main class="phone">

            <div class="topbar">
                <button class="btn-back" type="button" onclick="smartBack()">Back</button>
            </div>

            <!-- main content -->
            <div class="after-topbar">
                <div class="wrap">

                    <div id="posts"></div>

                <template id="postTpl">
                <article class="card">
                    <div class="card-head">
                    <span class="u-name">username</span>
                    <span class="u-year">year</span>
                    </div>

                    <div class="img-holder">
                    <img class="u-img" alt="roommate image"/>
                    </div>

                    <div class="info-line t-loc">&lt;place to live&gt;</div>
                    <div class="block title t-title">Post title</div>
                    <div class="block desc t-desc">Description…</div>
                    <div class="meta-small t-meta">Last edited —</div>

                    <div class="actions">
                    <button class="btn-action favBtn" type="button">
                        <span>favorites</span>
                        <span class="like-badge likeCount">(0)</span>
                    </button>
                    <a class="btn-action matchBtn" href="match_confirm.html">match</a>
                    </div>
                </article>
                </template>

                    
                </div>
            </div>
        </main>
    </div>

    <script>

        function smartBack() {
            if (document.referrer && document.referrer !== location.href) {
                history.back();
            } else {
                const base = location.pathname.replace(/[^\/]+$/, "");
                location.href = base + "home.html";
            }
        }


        function applyTopbarOffset() {
            const topbar = document.querySelector('.topbar');
            const after = document.querySelector('.after-topbar');
            if (!topbar || !after) return;
            const h = Math.ceil(topbar.getBoundingClientRect().height);
            const extra = 8; // extra breathing space
            after.style.marginTop = (h + extra) + 'px';
        }
        window.addEventListener('load', applyTopbarOffset);
        window.addEventListener('resize', applyTopbarOffset);
    </script>

    <!-- fetch roommate posts -->
        <script>
        const API_BASE = "http://127.0.0.1:5000"; // Flask server
        const API_LIST = `${API_BASE}/api/roommates`;

        const esc = s => String(s||"").replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
        );

        async function loadPosts() {
        try {
            const r = await fetch(API_LIST);
            const data = await r.json();
            if (!data.success) throw new Error("API error");

            const root = document.getElementById("posts");   
            root.innerHTML = "";                              

            if (!data.roommates || data.roommates.length === 0) {
            root.innerHTML = "<p>No roommate posts yet.</p>";
            return;
            }

            const tpl = document.getElementById("postTpl");

            data.roommates.forEach(p => {
            const frag = tpl.content.cloneNode(true);
              const card = frag.querySelector(".card");


            // username / year
            frag.querySelector(".u-name").textContent = p.username || "username";
            frag.querySelector(".u-year").textContent = p.year || "year";

            // image
            const imgHolder = frag.querySelector(".img-holder");
            const imgEl = frag.querySelector(".u-img");
            const firstImg = Array.isArray(p.images) && p.images[0] ? String(p.images[0]).trim() : "";
            if (firstImg) {
                imgEl.src = firstImg;
                imgEl.alt = p.title || "roommate image";
                card.classList.add("has-image");
            } else {
                card.classList.add("no-image");
            }

            // location / title / description
            frag.querySelector(".t-loc").innerHTML   = `&lt;${(p.location || "place to live")}&gt;`;
            frag.querySelector(".t-title").textContent = p.title || "Post title";
            frag.querySelector(".t-desc").textContent  = p.description || "Description…";

            // meta
            const when = p.updated_at || p.created_at;
            frag.querySelector(".t-meta").textContent =
                `Last edited ${when ? new Date(when).toLocaleString() : "—"}`;

            // favorites demo (client-side only)
            const likeBadge = frag.querySelector(".likeCount");
            let count = Number(p.favorites || 0);
            likeBadge.textContent = `(${count})`;
            frag.querySelector(".favBtn").addEventListener("click", () => {
                count += 1;
                likeBadge.textContent = `(${count})`;
            });

            // match link carries the id
            frag.querySelector(".matchBtn").href = `match_confirm.html?post=${encodeURIComponent(p.id || "")}`;

            root.appendChild(frag);
            });
        } catch (e) {
            console.error(e);
            alert("Failed to load posts. Check Flask/CORS.");
        }
        }

        window.addEventListener("load", loadPosts);
        </script>

    </body>

</html>