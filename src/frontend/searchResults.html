<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CasaConnect</title>
  <link rel="icon" href="../assets/icon.png" type="image/x-icon">
  <link rel="stylesheet" href="style_revised.css">
  <link rel="stylesheet" href="common_style.css">
</head>

<style>
  .post-section-title{
    display: flex;
    align-items: center;
    width: 100%;
    height: 40px;
    gap: 8px;
  }

  .button-container{
    margin-left: auto;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 5px;
  }

  .filter-button, .sort-button{
    border: none;
    background-color: var(--panel);
  }

  .filter-icon, .sort-icon{
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    aspect-ratio: 1/1;
  }
</style>

<body id="search-results-body" class="with-footer">
  <div class="screen"> 

    <div class="footer-nav">
      <div class="footer-item">
        <a class="item-link" href="home.html">
          <div data-svg-wrapper data-size="48">
            <svg width="48" height="49" viewBox="0 0 48 49" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M18 44.5V24.5H30V44.5M6 18.5L24 4.5L42 18.5V40.5C42 41.5609 41.5786 42.5783 40.8284 43.3284C40.0783 44.0786 39.0609 44.5 38 44.5H10C8.93913 44.5 7.92172 44.0786 7.17157 43.3284C6.42143 42.5783 6 41.5609 6 40.5V18.5Z"
                stroke="#1E1E1E" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <div class="footer-label">HOME<br /></div>
        </a>
      </div>
      <div class="footer-item">
        <a class="item-link" href="additem.html">
          <div data-svg-wrapper data-size="48">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="49" viewBox="0 0 48 49" fill="none">
              <path d="M22 34.5H26V26.5H34V22.5H26V14.5H22V22.5H14V26.5H22V34.5ZM24 44.5C21.2333 44.5 18.6333 43.9833 16.2 42.95C13.7667 41.8833 11.65 40.45 9.85 38.65C8.05 36.85 6.61667 34.7333 5.55 32.3C4.51667 29.8667 4 27.2667 4 24.5C4 21.7333 4.51667 19.1333 5.55 16.7C6.61667 14.2667 8.05 12.15 9.85 10.35C11.65 8.55 13.7667 7.13333 16.2 6.1C18.6333 5.03333 21.2333 4.5 24 4.5C26.7667 4.5 29.3667 5.03333 31.8 6.1C34.2333 7.13333 36.35 8.55 38.15 10.35C39.95 12.15 41.3667 14.2667 42.4 16.7C43.4667 19.1333 44 21.7333 44 24.5C44 27.2667 43.4667 29.8667 42.4 32.3C41.3667 34.7333 39.95 36.85 38.15 38.65C36.35 40.45 34.2333 41.8833 31.8 42.95C29.3667 43.9833 26.7667 44.5 24 44.5ZM24 40.5C28.4667 40.5 32.25 38.95 35.35 35.85C38.45 32.75 40 28.9667 40 24.5C40 20.0333 38.45 16.25 35.35 13.15C32.25 10.05 28.4667 8.5 24 8.5C19.5333 8.5 15.75 10.05 12.65 13.15C9.55 16.25 8 20.0333 8 24.5C8 28.9667 9.55 32.75 12.65 35.85C15.75 38.95 19.5333 40.5 24 40.5Z" fill="#1D1B20"/>
            </svg>
          </div>
          <div class="footer-label">ADD<br /></div>
        </a>
      </div>
      <div class="footer-item">
        <a class="item-link" href="profile.html">
          <div data-svg-wrapper>
            <svg width="48" height="49" viewBox="0 0 48 49" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M40 42.5V38.5C40 36.3783 39.1571 34.3434 37.6569 32.8431C36.1566 31.3429 34.1217 30.5 32 30.5H16C13.8783 30.5 11.8434 31.3429 10.3431 32.8431C8.84285 34.3434 8 36.3783 8 38.5V42.5M32 14.5C32 18.9183 28.4183 22.5 24 22.5C19.5817 22.5 16 18.9183 16 14.5C16 10.0817 19.5817 6.5 24 6.5C28.4183 6.5 32 10.0817 32 14.5Z"
                stroke="#1E1E1E" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M8 42.5H39.5" stroke="black" stroke-width="4" />
            </svg>
          </div>
          <div class="footer-label">PROFILE</div>
        </a>
      </div>
    </div>

    <div class="phone">

          <div class="logo">
            <img src="../assets/Logo.svg" alt="CasaConnect Logo">
            <h1>CasaConnect</h1>
          </div>

          <div class="main-content">
            <div class="search-section">

              <form id="searchForm" class="search-bar" action="searchResults.html" method="GET">
                <input id="searchInput" name="q" class="search-placeholder" type="text" placeholder="Search...">
                <button type="submit" class="search-icon-container" style="border: none; background: none; cursor: pointer;">
                  <img class="search-icon" src="../assets/search.svg" alt="search icon">
                </button>
              </form>
            </div>

            <div id="searchResults" class="post-section">
              <div class="post-section-title">
                <h4>Search Results</h4>
                <div class="button-container">
                  <button class="filter-button">
                    <img class="filter-icon" src="../assets/filter.svg" alt="filter icon">
                  </button>
                  <button class="sort-button">
                    <img class="sort-icon" src="../assets/sort.svg" alt="sort icon">
                  </button>
                </div>
              </div>
              <!-- Search results will be displayed here -->
            </div>

            </div>
          </div>

          <p>Â© CTRL Squad, 2025</p>
        </div>
  </div>

  <script>
    function formatDate(dateString) {
      if (!dateString) return 'Unknown date';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Unknown date';
        
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
          return 'Today';
        } else if (diffDays === 1) {
          return 'Yesterday';
        } else {
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
      } catch (e) {
        return 'Unknown date';
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function createPostCard(post) {
      const title = escapeHtml(post.title || 'Untitled Post');
      // Get the first image from the images array, fall back to image_url, then default image
      const imageUrl = (post.images && post.images.length > 0) ? post.images[0] : 
                      (post.image_url || '../assets/icon.png');
      const authorName = escapeHtml(post.author_name || 'Unknown User');
      const favoritesCount = parseInt(post.favorites_count) || 0;
      const dateFormatted = formatDate(post.created_at);
      
      // Create an author link if we have an author ID
      const authorLink = post.author_id ? 
        `<a href="profile.html?id=${escapeHtml(post.author_id)}" class="post-meta-label author-link">${authorName}</a>` :
        `<span class="post-meta-label">${authorName}</span>`;
      
      return `
        <a href="exchange_post.html?id=${escapeHtml(post._id)}" class="post-card">
          <div class="post-card">
            <div class="post-title">${title}</div>
            <hr class="post-divider">
            <div class="post-content-row">
              <img class="post-image" src="${imageUrl}" alt="${title}" onerror="this.src='../assets/icon.png'">
              <div class="post-meta">
                ${authorLink}
                <div class="post-meta-label">${favoritesCount} favorites</div>
                <div class="post-meta-label">${dateFormatted}</div>
              </div>
            </div>
          </div>
        </a>
      `;
    }

    // Function to get URL parameters
    function getUrlParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Load search results when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      const query = getUrlParam('q');
      
      if (query) {
        document.getElementById('searchInput').value = query;
        const searchResultsDiv = document.getElementById('searchResults');
        
        try {
          const response = await fetch(`http://localhost:5000/api/search/?q=${encodeURIComponent(query)}`, {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            credentials: 'include'
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Search failed');
          }

          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'Search failed');
          }
          
          if (!Array.isArray(data.results)) {
            throw new Error('Invalid response format');
          }

          // Update results count in header
          const resultsContainer = searchResultsDiv.querySelector('.post-section-title');
          resultsContainer.innerHTML = `
            <h4>Search Results (${data.results.length})</h4>
            <div class="button-container">
              <button class="filter-button">
                <img class="filter-icon" src="../assets/filter.svg" alt="filter icon">
              </button>
              <button class="sort-button">
                <img class="sort-icon" src="../assets/sort.svg" alt="sort icon">
              </button>
            </div>
          `;

          // Create a new container for results
          const resultsArea = document.createElement('div');
          resultsArea.className = 'search-results-area';

          if (data.results.length === 0) {
            resultsArea.innerHTML = `
              <div class="no-results">
                <p>No results found for "${escapeHtml(query)}"</p>
                <p>Try different keywords or check your spelling</p>
              </div>
            `;
          } else {
            const resultsHtml = data.results.map(post => {
              try {
                return createPostCard(post);
              } catch (err) {
                console.error('Error creating post card:', err);
                return '';
              }
            }).filter(html => html).join('');
            
            resultsArea.innerHTML = resultsHtml;
          }

          // Replace old results with new ones
          const oldResults = searchResultsDiv.querySelector('.search-results-area');
          if (oldResults) {
            oldResults.remove();
          }
          searchResultsDiv.appendChild(resultsArea);
        } catch (error) {
          console.error('Search error:', error);
          searchResultsDiv.innerHTML = '<div class="error">Failed to perform search. Please try again.</div>';
        }
        } else {
          console.error('Search error:', error);
          searchResultsDiv.innerHTML = `
            <div class="error">
              <p>Failed to perform search.</p>
              <p>Please try again later.</p>
              <p class="error-details">${escapeHtml(error.message)}</p>
            </div>`;
        }
      }
    );

    // Prevent empty searches
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        e.preventDefault();
      }
    });
  </script>

  <style>
    .author-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .author-link:hover {
      text-decoration: underline;
    }

    .no-results {
      padding: 30px;
      text-align: center;
      color: #666;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 20px 0;
    }

    .no-results p {
      margin: 10px 0;
    }

    .error {
      padding: 30px;
      text-align: center;
      color: #ff4444;
      background: #fff5f5;
      border-radius: 8px;
      margin: 20px 0;
    }

    .error p {
      margin: 10px 0;
    }

    .error-details {
      font-size: 0.9em;
      color: #666;
      margin-top: 15px;
    }

    .search-results-area {
      margin-top: 20px;
    }

    .search-icon-container {
      padding: 0;
      cursor: pointer;
    }
  </style>
</body>

</html>