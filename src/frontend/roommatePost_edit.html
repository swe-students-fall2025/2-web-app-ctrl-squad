<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CasaConnect â€” Edit Roommate Post</title>
    <link rel="stylesheet" href="common_style.css" />
    <style>
        .phone {
            padding-top: 28px;
        }

        .after-topbar {
            margin-top: 0;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 0 16px;
        }

        h1 {
            margin: 0;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 5px;
        }

        textarea.input-field {
            min-height: 120px;
            resize: vertical;
        }

        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-submit {
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
        }

        .btn-submit:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .error-message {
            color: #c93b3b;
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }
    </style>
</head>

<body class="no-footer">
    <div class="screen">
        <main class="phone">

            <div class="topbar">
                <button class="btn-back" type="button" onclick="smartBack()">Back</button>
            </div>

            <!-- main content -->
            <div class="after-topbar">
                <div class="wrap">
                    <h1>Edit Roommate Post</h1>

                    <form id="editRoommateForm">
                        <div class="input-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" name="title" class="input-field" required placeholder="Give your post a title">
                            <div class="error-message" id="title-error"></div>
                        </div>

                        <div class="input-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" class="input-field" placeholder="Where are you looking to live?">
                            <div class="helper-text">e.g., North Campus, South Campus, Off-campus apartment</div>
                            <div class="error-message" id="location-error"></div>
                        </div>

                        <div class="input-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" class="input-field" required placeholder="Describe what you're looking for in a roommate, your living habits, etc."></textarea>
                            <div class="error-message" id="description-error"></div>
                        </div>

                        <div class="input-group">
                            <label for="preferences">Preferences (comma-separated)</label>
                            <input type="text" id="preferences" name="preferences" class="input-field" placeholder="e.g., Non-smoker, early riser, quiet">
                            <div class="helper-text">Separate each preference with a comma</div>
                            <div class="error-message" id="preferences-error"></div>
                        </div>

                        <div class="input-group">
                            <label for="year">Year</label>
                            <input type="text" id="year" name="year" class="input-field" placeholder="e.g., Sophomore, Junior, Senior">
                            <div class="error-message" id="year-error"></div>
                        </div>

                        <div class="actions">
                            <button type="submit" class="btn-submit" id="submitBtn">Update Roommate Post</button>
                        </div>

                        <div class="success-message" id="success-message">Roommate post updated successfully!</div>
                        <div class="error-message" id="form-error">There was a problem updating your post. Please try again.</div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        function smartBack() {
            // Store destination before going back
            const destination = document.referrer && document.referrer !== location.href 
                ? document.referrer 
                : location.pathname.replace(/[^\/]+$/, "") + "roommate_post.html?id=" + getUrlParam('id');
            
            // Navigate to destination
            location.href = destination;
        }

        function applyTopbarOffset() {
            const topbar = document.querySelector('.topbar');
            const after = document.querySelector('.after-topbar');
            if (!topbar || !after) return;
            const h = Math.ceil(topbar.getBoundingClientRect().height);
            const extra = 8; // extra breathing space
            after.style.marginTop = (h + extra) + 'px';
        }
        window.addEventListener('load', applyTopbarOffset);
        window.addEventListener('resize', applyTopbarOffset);
    </script>

    <!-- edit roommate post functionality -->
    <script>
        const API_BASE = "http://127.0.0.1:5000"; // Flask server

        // Function to get URL parameters
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Function to show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Function to hide error message
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }

        // Function to validate the form
        function validateForm() {
            let isValid = true;

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            // Validate title
            if (!title) {
                showError('title-error', 'Title is required');
                isValid = false;
            } else {
                hideError('title-error');
            }

            // Validate description
            if (!description) {
                showError('description-error', 'Description is required');
                isValid = false;
            } else {
                hideError('description-error');
            }

            return isValid;
        }

        // Function to load the existing roommate post data
        async function loadRoommatePost() {
            try {
                const postId = getUrlParam('id');
                if (!postId) {
                    showError('form-error', 'No post ID provided');
                    return;
                }

                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    showError('form-error', 'You must be logged in to edit a post');
                    document.getElementById('submitBtn').disabled = true;
                    return;
                }

                document.getElementById('submitBtn').textContent = 'Loading...';
                document.getElementById('submitBtn').disabled = true;

                const response = await fetch(`${API_BASE}/api/roommates/${postId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    credentials: 'include',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch post: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success || !data.post) {
                    throw new Error('Failed to fetch post data');
                }

                const post = data.post;
                
                // Check if the current user is the owner
                const postOwnerId = post.user_id || post.userId || '';
                const isOwner = post.is_owner === true || 
                                (postOwnerId && userId && postOwnerId.toString() === userId.toString());
                
                if (!isOwner) {
                    showError('form-error', 'You do not have permission to edit this post');
                    document.getElementById('submitBtn').disabled = true;
                    return;
                }

                // Fill the form with the post data
                document.getElementById('title').value = post.title || '';
                document.getElementById('location').value = post.location || '';
                document.getElementById('description').value = post.description || '';
                document.getElementById('year').value = post.year || '';

                // Handle preferences (array to comma-separated string)
                if (post.preferences && Array.isArray(post.preferences)) {
                    document.getElementById('preferences').value = post.preferences.join(', ');
                }

                document.getElementById('submitBtn').textContent = 'Update Roommate Post';
                document.getElementById('submitBtn').disabled = false;

            } catch (error) {
                console.error('Error loading roommate post:', error);
                showError('form-error', `Error loading post: ${error.message}`);
                document.getElementById('form-error').style.display = 'block';
            }
        }

        // Function to handle form submission
        async function handleSubmit(event) {
            event.preventDefault();
            
            // Hide all error messages
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('success-message').style.display = 'none';
            
            if (!validateForm()) {
                return;
            }
            
            try {
                const postId = getUrlParam('id');
                if (!postId) {
                    showError('form-error', 'No post ID provided');
                    return;
                }
                
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    showError('form-error', 'You must be logged in to update a post');
                    return;
                }
                
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.textContent = 'Updating...';
                submitBtn.disabled = true;
                
                // Get form values
                const title = document.getElementById('title').value.trim();
                const location = document.getElementById('location').value.trim();
                const description = document.getElementById('description').value.trim();
                const preferencesStr = document.getElementById('preferences').value.trim();
                const year = document.getElementById('year').value.trim();
                
                // Convert preferences string to array
                const preferences = preferencesStr
                    ? preferencesStr.split(',').map(pref => pref.trim()).filter(pref => pref)
                    : [];
                
                // Prepare request payload
                const updateData = {
                    title,
                    location,
                    description,
                    preferences,
                    year
                };
                
                const response = await fetch(`${API_BASE}/api/roommates/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    credentials: 'include',
                    mode: 'cors',
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update post: ${response.status}`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Failed to update post');
                }
                
                // Show success message
                document.getElementById('success-message').style.display = 'block';
                document.getElementById('success-message').textContent = 'Roommate post updated successfully!';
                
                // Reset button state
                submitBtn.textContent = 'Update Roommate Post';
                submitBtn.disabled = false;
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = `roommate_post.html?id=${postId}`;
                }, 1500);
                
            } catch (error) {
                console.error('Error updating roommate post:', error);
                showError('form-error', `Error: ${error.message}`);
                document.getElementById('submitBtn').textContent = 'Update Roommate Post';
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // Add event listener for form submission
        document.getElementById('editRoommateForm').addEventListener('submit', handleSubmit);

        // Load the roommate post data when the page loads
        window.addEventListener('load', loadRoommatePost);
    </script>
</body>

</html>