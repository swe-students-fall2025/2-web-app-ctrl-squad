<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CasaConnect â€” Profile</title>
  <link rel="stylesheet" href="common_style.css" />

  <style>
    .footer-nav .item-link,
    .footer-nav .item-link:hover,
    .footer-nav .item-link:focus,
    .footer-nav .item-link:active {
      text-decoration: none;
    }

    .phone.no-topbar { padding-top: 28px; }

    .profile-wrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .logout-button {
      background-color: #ff4444;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }

    .logout-button:hover {
      background-color: #ff0000;
    }

    /* Profile info card */
    .profile-card {
      display: grid;
      grid-template-columns: 88px 1fr;
      gap: 16px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--drop);
      border-radius: 14px;
      padding: 14px;
    }

    .avatar {
      width: 88px;
      height: 88px;
      border-radius: 10px;
      background: #e6e6e6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
    }

    .row-compact {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
    }
    .row-compact + .row-compact { margin-top: 12px; }

    .skel-input {
      background: #e6e6e6;
      border-radius: 12px;
      padding: 10px 12px;
      min-height: 32px;
      display: flex;
      align-items: center;
      color: #606060;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
    }

    .post-head .skel-input { width: auto !important; flex: 1; }

    /* edit button */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 10px;
      background: #000;
      color: #fff;
      text-decoration: none;
      border: 2px solid #000;
      font-size: 12px;
      white-space: nowrap;
    }

    /* Manage buttons */
    .manage-row {
      display: flex;
      justify-content: space-between; 
      gap: 12px;
      width: 100%;
      flex-wrap: wrap; 
    }
    .btn-solid {
      text-decoration: none;
      color: #fff;
      background: #000;
      border: 2px solid #000;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      text-align: center;
      flex: 1 1 48%; 
    }

    /* posts lists */
    .section-title {
      font-weight: 700;
      font-size: 16px;
      border-left: 4px solid #000;
      padding-left: 8px;
      margin: 6px 0;
    }

    .post {
      width: 100%;
      border: 1px solid var(--drop);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--panel);
    }

    .post-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .badge {
      text-decoration: none;
      color: #fff;
      background: #000;
      /* border: 2px solid #000; */
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
    }

    .post-body {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 12px;
    }

    .media {
      height: 200px;
      border-radius: 10px;
      background: #777;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px;
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .skel-chip {
      background: #efefef;
      border: 1px solid var(--drop);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      color: #606060;
    }

    .spacer {
      height: 2px;
      background: #eee;
      margin: 6px 0;
    }

    @media (max-width: 393px) {
      .post-body { grid-template-columns: 1fr; }
    }


        .btn-status {
            pointer-events: none;
        }

        .btn-notice{
            background:#f0a500;
            color: #fff;
        }

        .btn-danger{
            background:#c93b3b;
            color:#fff;
        }

        .btn-great{
            background: #62905e;
            color: #fff;
        }
        .muted{ color:var(--ink-2); text-align:center; }
  </style>
</head>

<body class="with-footer">
  <div class="screen">
    <!-- no topbar -->
    <main class="phone no-topbar">
      <div class="profile-wrap">

        <!-- Profile info -->
        <section class="profile-card" id="profileInfo">
          <div class="avatar" aria-label="profile image placeholder">image</div>

          <div class="info">
            <div class="row-compact">
              <div class="skel-input" aria-label="username">Loading...</div>
              <a class="pill" href="profile_edit.html">edit</a>
            </div>
            <div class="row-compact">
              <div class="skel-input" aria-label="bio">Loading...</div>
              <div></div>
            </div>
            <div class="row-compact">
              <div class="skel-input" aria-label="nyu id">Loading...</div>
              <div></div>
            </div>
            <div class="row-compact">
              <div class="skel-input" aria-label="location">Loading...</div>
              <div></div>
            </div>
            <button class="logout-button" onclick="handleLogout()">Logout</button>
          </div>
        </section>
        
        <script>
          // Handle logout
          async function handleLogout() {
            try {
              const response = await fetch('http://localhost:5000/api/auth/logout', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                credentials: 'include'
              });

              if (response.ok) {
                // Clear local storage
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                // Redirect to login page
                window.location.href = 'login.html';
              } else {
                console.error('Logout failed:', response.status);
                alert('Logout failed. Please try again.');
              }
            } catch (error) {
              console.error('Logout error:', error);
              alert('Logout failed. Please try again.');
            }
          }

          // Check for authentication
          function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
              console.log('No token found');
              return false;
            }
            return token;
          }

          // Load profile information
          async function loadProfileInfo() {
            const token = checkAuth();
            if (!token) {
              console.log('No auth token, redirecting to login');
              window.location.href = 'login.html';
              return;
            }

            try {
              // Keep the Authorization header with Bearer token
              const response = await fetch('http://127.0.0.1:5000/api/users/profile', {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                credentials: 'include'
              });

              if (!response.ok) {
                const errorData = await response.json();
                console.error('Profile fetch failed:', response.status, errorData);
                
                if (response.status === 401) {
                  // Token expired or invalid
                  localStorage.removeItem('token');
                  window.location.href = 'login.html';
                  return;
                }
                
                throw new Error(errorData.error || 'Failed to fetch profile');
              }

              const { success, data: profile } = await response.json();
              console.log('Profile response:', { success, profile });
              
              if (!success || !profile) {
                throw new Error('Invalid profile data received');
              }

              const info = document.querySelector('#profileInfo .info');
              
              // Save the logout button if it exists
              const existingLogoutButton = info.querySelector('.logout-button');
              
              info.innerHTML = `
                <div class="row-compact">
                  <div class="skel-input" aria-label="username">${profile.username || 'No username set'}</div>
                  <a class="pill" href="profile_edit.html">edit</a>
                </div>
                <div class="row-compact">
                  <div class="skel-input" aria-label="bio">${profile.bio || 'No bio yet'}</div>
                  <div></div>
                </div>
                <div class="row-compact">
                  <div class="skel-input" aria-label="nyu id">${profile.nyu_id || 'No NYU ID set'}</div>
                  <div></div>
                </div>
                <div class="row-compact">
                  <div class="skel-input" aria-label="email">${profile.email || 'No email set'}</div>
                  <div></div>
                </div>
              `;
              
              // Re-add the logout button
              if (existingLogoutButton) {
                info.appendChild(existingLogoutButton);
              } else {
                const logoutButton = document.createElement('button');
                logoutButton.className = 'logout-button';
                logoutButton.onclick = handleLogout;
                logoutButton.textContent = 'Logout';
                info.appendChild(logoutButton);
              }

            } catch (error) {
              console.error('Error loading profile:', error);
              document.querySelector('#profileInfo .info').innerHTML = 
                '<div class="muted">Failed to load profile information. Please try again later.</div>';
            }
          }

          // Load profile when page loads
          document.addEventListener('DOMContentLoaded', loadProfileInfo);
        </script>

        <!-- Manage buttons -->
        <div class="manage-row">
          <a class="btn-solid" href="profile_posts.html">Manage Posts</a>
          <a class="btn-solid" href="manage_order.html">Manage Orders</a>
        </div>

        <!-- posts -->
        <h3 class="section-title">Your Posts</h3>
        <div id="userPosts">
          <!-- Posts will be loaded here -->
          <p class="muted">Loading your posts...</p>
        </div>

        <article class="post">
          <div class="post-head">
            <a class="skel-input"  href="exchange_post.html">post title</a>
            <a class="badge btn-notice" href="seller_trade_page.html"> New Request</a>
          </div>
          <div class="post-body">
            <div class="media">image / description</div>
            <div class="meta">
              <div class="skel-chip">favorites</div>
              <div class="skel-chip">username</div>
              <div class="skel-chip">time posted</div>
            </div>
          </div>
        </article>

        <div class="spacer"></div>
      
        <article class="post">
          <div class="post-head">
            <a class="skel-input" href="exchange_post.html">post title</a>
            <a class="badge btn-great" href="seller_trade_page.html"> Matched</a>
          </div>
          <div class="post-body">
            <div class="media">image / description</div>
            <div class="meta">
              <div class="skel-chip">favorites</div>
              <div class="skel-chip">username</div>
              <div class="skel-chip">time posted</div>
            </div>
          </div>
        </article>
        <script>
          // Function to format date
          function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric' 
            });
          }

          // Function to load and display user posts
          async function loadUserPosts() {
            try {
              const response = await fetch('http://127.0.0.1:5000/api/users/profile/posts', {
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('token')}`,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                credentials: 'include'
              });
              
              if (!response.ok) throw new Error('Failed to fetch posts');
              
              const { posts } = await response.json();
              const postsContainer = document.getElementById('userPosts');
              
              if (posts.length === 0) {
                postsContainer.innerHTML = '<p class="muted">No posts yet. Create your first post!</p>';
                return;
              }

              postsContainer.innerHTML = posts.map(post => `
                <article class="post">
                  <div class="post-head">
                    <div class="skel-input" style="width:180px;">${post.title}</div>
                    ${post.tradeStatus ? `
                      <a class="badge ${post.tradeStatus === 'pending' ? 'btn-neutral' : 'btn-great'}" 
                         href="seller_trade_page.html?postId=${post._id}">
                        ${post.tradeStatus === 'pending' ? 'Exchange Request Pending' : 'Exchange Request Accepted'}
                      </a>
                    ` : ''}
                  </div>
                  <div class="post-body">
                    <div class="media">
                      ${post.imageUrl ? 
                        `<img src="${post.imageUrl}" alt="${post.title}" style="width:100%; height:100%; object-fit:cover;">` :
                        post.description || 'No description available'
                      }
                    </div>
                    <div class="meta">
                      <div class="skel-chip">${post.favorites?.length || 0} favorites</div>
                      <div class="skel-chip">Type: ${post.type}</div>
                      <div class="skel-chip">Posted: ${formatDate(post.createdAt)}</div>
                      ${post.price ? `<div class="skel-chip">Price: $${post.price}</div>` : ''}
                      ${post.condition ? `<div class="skel-chip">Condition: ${post.condition}</div>` : ''}
                    </div>
                  </div>
                </article>
                <div class="spacer"></div>
              `).join('');
              
            } catch (error) {
              console.error('Error loading posts:', error);
              document.getElementById('userPosts').innerHTML = 
                '<p class="muted">Failed to load posts. Please try again later.</p>';
            }
          }

          // Load posts when the page loads
          document.addEventListener('DOMContentLoaded', loadUserPosts);
        </script>

      </div>
    </main>
  </div>

  <!-- footer -->
  <div class="footer-nav">
    <div class="footer-item">
      <a class="item-link" href="home.html">
        <div data-svg-wrapper data-size="48">
          <svg width="48" height="49" viewBox="0 0 48 49" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 44.5V24.5H30V44.5M6 18.5L24 4.5L42 18.5V40.5C42 41.5609 41.5786 42.5783 40.8284 43.3284C40.0783 44.0786 39.0609 44.5 38 44.5H10C8.93913 44.5 7.92172 44.0786 7.17157 43.3284C6.42143 42.5783 6 41.5609 6 40.5V18.5Z"
                  stroke="#1E1E1E" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="footer-label">HOME<br /></div>
      </a>
    </div>
    <div class="footer-item">
      <a class="item-link" href="additem.html">
        <div data-svg-wrapper data-size="48">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="49" viewBox="0 0 48 49" fill="none">
            <path d="M22 34.5H26V26.5H34V22.5H26V14.5H22V22.5H14V26.5H22V34.5ZM24 44.5C21.2333 44.5 18.6333 43.9833 16.2 42.95C13.7667 41.8833 11.65 40.45 9.85 38.65C8.05 36.85 6.61667 34.7333 5.55 32.3C4.51667 29.8667 4 27.2667 4 24.5C4 21.7333 4.51667 19.1333 5.55 16.7C6.61667 14.2667 8.05 12.15 9.85 10.35C11.65 8.55 13.7667 7.13333 16.2 6.1C18.6333 5.03333 21.2333 4.5 24 4.5C26.7667 4.5 29.3667 5.03333 31.8 6.1C34.2333 7.13333 36.35 8.55 38.15 10.35C39.95 12.15 41.3667 14.2667 42.4 16.7C43.4667 19.1333 44 21.7333 44 24.5C44 27.2667 43.4667 29.8667 42.4 32.3C41.3667 34.7333 39.95 36.85 38.15 38.65C36.35 40.45 34.2333 41.8833 31.8 42.95C29.3667 43.9833 26.7667 44.5 24 44.5ZM24 40.5C28.4667 40.5 32.25 38.95 35.35 35.85C38.45 32.75 40 28.9667 40 24.5C40 20.0333 38.45 16.25 35.35 13.15C32.25 10.05 28.4667 8.5 24 8.5C19.5333 8.5 15.75 10.05 12.65 13.15C9.55 16.25 8 20.0333 8 24.5C8 28.9667 9.55 32.75 12.65 35.85C15.75 38.95 19.5333 40.5 24 40.5Z"
                  fill="#1D1B20"/>
          </svg>
        </div>
        <div class="footer-label">ADD</div>
      </a>
    </div>
    <div class="footer-item">
      <a class="item-link" href="profile.html">
        <div data-svg-wrapper>
          <svg width="48" height="49" viewBox="0 0 48 49" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M40 42.5V38.5C40 36.3783 39.1571 34.3434 37.6569 32.8431C36.1566 31.3429 34.1217 30.5 32 30.5H16C13.8783 30.5 11.8434 31.3429 10.3431 32.8431C8.84285 34.3434 8 36.3783 8 38.5V42.5M32 14.5C32 18.9183 28.4183 22.5 24 22.5C19.5817 22.5 16 18.9183 16 14.5C16 10.0817 19.5817 6.5 24 6.5C28.4183 6.5 32 10.0817 32 14.5Z"
                  stroke="#1E1E1E" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 42.5H39.5" stroke="black" stroke-width="4" />
          </svg>
        </div>
        <div class="footer-label">PROFILE</div>
      </a>
    </div>
  </div>

</body>
</html>
